---
alwaysApply: true
---

# Regla Principal de Memoria Persistente - Optimizada

## B√∫squeda Autom√°tica Obligatoria

### Al Inicio de Cada Prompt
**SIEMPRE** ejecutar antes de responder:

```python
# B√∫squeda principal en codebase
mcp_chroma_query_documents(
    collection_name="codebase_v1",
    query_texts=[prompt_del_usuario],
    n_results=5
)

# B√∫squeda en derived learnings para patrones validados
mcp_chroma_query_documents(
    collection_name="derived_learnings_v1",
    query_texts=[prompt_del_usuario],
    n_results=3
)
```

## Comportamiento Obligatorio

### Formato de Respuesta
- **SIEMPRE** mostrar "üîç Contexto de Memoria:" al inicio si hay resultados relevantes
- **SIEMPRE** incluir resultados encontrados cuando sean √∫tiles
- **SIEMPRE** usar contexto para enriquecer la respuesta

### Colecciones Disponibles
Las colecciones reales de ChromaDB seg√∫n `reset_collections.py`:
- `codebase_v1` - C√≥digo fuente del proyecto
- `chat_history_v1` - Historial de conversaciones con contexto enriquecido
- `derived_learnings_v1` - Aprendizajes derivados y patrones validados
- `thinking_sessions_v1` - Sesiones de pensamiento estructurado
- `validation_evidence_v1` - Evidencia de validaci√≥n (tests, verificaciones)
- `test_results_v1` - Resultados de tests

## Enhanced Context Capture

### Caracter√≠sticas Clave
- **Code Diff Extraction**: Captura autom√°tica de cambios en c√≥digo
- **Tool Sequence Tracking**: Seguimiento de secuencia de herramientas usadas
- **Bidirectional Linking**: Enlaces bidireccionales entre c√≥digo y conversaciones
- **Confidence Scoring**: Puntuaci√≥n de confianza para interacciones

### Uso de Contexto Enriquecido
Al consultar `chat_history_v1`, el contexto incluye:
- Diferencias de c√≥digo (diffs)
- Secuencia de herramientas utilizadas
- Tipo de modificaci√≥n (refactor/bugfix/feature/documentation)
- Puntuaci√≥n de confianza
- Enlaces a c√≥digo relacionado

## Derived Learnings Workflow

### Promoci√≥n de Aprendizajes
Los aprendizajes derivados (`derived_learnings_v1`) son patrones validados y curados manualmente:
- Promover desde `chat_history_v1` cuando hay alta confianza
- Vincular con `validation_evidence_v1` cuando hay evidencia de tests
- Usar en b√∫squedas RAG para priorizar soluciones validadas

### Uso en B√∫squedas
```python
# Buscar en derived learnings para patrones validados
mcp_chroma_query_documents(
    collection_name="derived_learnings_v1",
    query_texts=["patr√≥n soluci√≥n validada"],
    n_results=3
)
```

## Thinking Sessions

### Uso de Sesiones de Pensamiento
Las sesiones de pensamiento (`thinking_sessions_v1`) permiten:
- Registrar cadenas de pensamiento secuenciales
- Crear ramas de pensamiento alternativas
- Encontrar pensamientos similares entre sesiones

### Integraci√≥n con Contexto
Las sesiones de pensamiento pueden vincularse con:
- Entradas de `chat_history_v1`
- Chunks de c√≥digo en `codebase_v1`
- Evidencia de validaci√≥n en `validation_evidence_v1`

## Validation Evidence

### Evidencia de Validaci√≥n
La colecci√≥n `validation_evidence_v1` almacena:
- Transiciones de tests (test fallido ‚Üí test pasado)
- Verificaciones de soluciones
- Evidencia de correcci√≥n de bugs

### Uso en Workflow
- Vincular evidencia con derived learnings
- Validar soluciones antes de promover
- Rastrear correcciones de bugs

## Test Results Integration

### Resultados de Tests
La colecci√≥n `test_results_v1` almacena:
- Resultados de tests unitarios e integraci√≥n
- Cobertura de c√≥digo
- Estado de tests (passed/failed)

### Integraci√≥n con C√≥digo
- Vincular tests con c√≥digo en `codebase_v1`
- Usar resultados para validar cambios
- Promover patrones de testing exitosos

## Auto-Guardado Inteligente

### Detecci√≥n Autom√°tica
- Si se menciona "decidimos", "decidir" ‚Üí considerar guardar en `derived_learnings_v1`
- Si se menciona "bug", "error" ‚Üí buscar en `validation_evidence_v1` y `chat_history_v1`
- Si se menciona "test", "testing" ‚Üí buscar en `test_results_v1` y `validation_evidence_v1`

### Patrones Arquitect√≥nicos
- Repository Pattern ‚Üí buscar en `derived_learnings_v1`
- Service Pattern ‚Üí buscar en `derived_learnings_v1`
- Controller Pattern ‚Üí buscar en `derived_learnings_v1`

## Optimizaci√≥n de Rendimiento

### Colecciones Prioritarias
1. `codebase_v1` - B√∫squeda principal de c√≥digo
2. `derived_learnings_v1` - Patrones validados (priorizar)
3. `chat_history_v1` - Contexto hist√≥rico
4. `test_results_v1` - Resultados de tests
5. `validation_evidence_v1` - Evidencia de validaci√≥n
6. `thinking_sessions_v1` - Sesiones de pensamiento

### L√≠mites de B√∫squeda
- M√°ximo 5 resultados por colecci√≥n principal
- M√°ximo 3 resultados por colecci√≥n secundaria
- Priorizar resultados de `derived_learnings_v1` cuando existan

## Integraci√≥n con MCP

### Herramientas Disponibles
- `mcp_chroma_query_documents`: B√∫squeda sem√°ntica en colecciones
- `mcp_chroma_add_document_with_id_and_metadata`: Guardar documentos
- `mcp_chroma_get_documents_by_ids`: Recuperar documentos espec√≠ficos
- `mcp_chroma_update_document_content`: Actualizar contenido
- `mcp_chroma_delete_document_by_id`: Eliminar documentos
- `mcp_chroma_log_chat`: Logging autom√°tico de chat con contexto enriquecido
- `mcp_chroma_sequential_thinking`: Registrar pensamientos secuenciales
- `mcp_chroma_find_similar_thoughts`: Encontrar pensamientos similares

### Flujo de Trabajo
1. **B√∫squeda autom√°tica** en `codebase_v1` y `derived_learnings_v1`
2. **B√∫squeda contextual** seg√∫n palabras clave en otras colecciones
3. **Enriquecimiento** de respuesta con contexto
4. **Auto-logging** de sesiones significativas (via `auto_log_chat.mdc`)
5. **Promoci√≥n** de aprendizajes cuando sea apropiado

## Mejores Pr√°cticas

### B√∫squeda Sem√°ntica
- Usar descripciones naturales en lugar de t√©rminos t√©cnicos exactos
- Ejemplo: "servicio de autenticaci√≥n" en lugar de "AuthService"
- Combinar contexto con b√∫squeda espec√≠fica

### Metadata Rica
- Siempre incluir metadata descriptiva
- Usar tags consistentes
- Vincular con c√≥digo y conversaciones relacionadas

### Mantenimiento Continuo
- Revisar `derived_learnings_v1` peri√≥dicamente
- Promover aprendizajes de alta calidad desde `chat_history_v1`
- Vincular evidencia de validaci√≥n con aprendizajes
